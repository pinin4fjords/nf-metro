%%metro title: Variant Calling Pipeline
%%metro style: dark
%%metro line: wgs | Whole Genome | #2db572
%%metro line: wes | Whole Exome | #0570b0
%%metro line: panel | Targeted Panel | #f5c542
%%metro line: rna_var | RNA Variants | #e63946

graph LR
    subgraph input_qc [Input & QC]
        %%metro exit: right | wgs, wes, panel, rna_var
        input[Input]
        fastqc[FastQC]
        fastp[FastP]
        trimgalore[Trim Galore!]
        fastqc_trim[FastQC]

        input -->|wgs,wes,panel,rna_var| fastqc
        fastqc -->|wgs,wes,panel,rna_var| fastp
        fastqc -->|wgs,wes,panel,rna_var| trimgalore
        fastp -->|wgs,wes,panel,rna_var| fastqc_trim
        trimgalore -->|wgs,wes,panel,rna_var| fastqc_trim
    end

    subgraph alignment [Alignment]
        %%metro entry: left | wgs, wes, panel, rna_var
        %%metro exit: right | wgs, wes, panel
        %%metro exit: right | rna_var
        bwa[BWA-MEM2]
        star_align[STAR]
        samtools[SAMtools sort]
        markdup[MarkDuplicates]
        bqsr[BQSR]

        bwa -->|wgs,wes,panel| samtools
        star_align -->|rna_var| samtools
        samtools -->|wgs,wes,panel,rna_var| markdup
        markdup -->|wgs,wes,panel,rna_var| bqsr
    end

    subgraph dna_calling [DNA Variant Calling]
        %%metro entry: left | wgs, wes, panel
        %%metro exit: right | wgs, wes, panel
        haplotypecaller[HaplotypeCaller]
        deepvariant[DeepVariant]
        strelka[Strelka2]
        merge_vcf[Merge VCFs]

        haplotypecaller -->|wgs| merge_vcf
        deepvariant -->|wes| merge_vcf
        strelka -->|panel| merge_vcf
    end

    subgraph rna_calling [RNA Variant Calling]
        %%metro entry: left | rna_var
        %%metro exit: right | rna_var
        splitncigar[SplitNCigar]
        rna_hc[HaplotypeCaller]
        rna_filter[FilterVariants]

        splitncigar -->|rna_var| rna_hc
        rna_hc -->|rna_var| rna_filter
    end

    subgraph annotation [Annotation & Filtering]
        %%metro entry: left | wgs, wes, panel, rna_var
        %%metro exit: right | wgs, wes, panel, rna_var
        vep[VEP]
        snpsift[SnpSift]
        filter_pass[Filter PASS]

        vep -->|wgs,wes,panel,rna_var| snpsift
        snpsift -->|wgs,wes,panel,rna_var| filter_pass
    end

    subgraph reporting [Reporting]
        %%metro entry: left | wgs, wes, panel, rna_var
        bcftools_stats[bcftools stats]
        multiqc[MultiQC]

        bcftools_stats -->|wgs,wes,panel,rna_var| multiqc
    end

    fastqc_trim -->|wgs,wes,panel| bwa
    fastqc_trim -->|rna_var| star_align
    bqsr -->|wgs| haplotypecaller
    bqsr -->|wes| deepvariant
    bqsr -->|panel| strelka
    bqsr -->|rna_var| splitncigar
    merge_vcf -->|wgs,wes,panel| vep
    rna_filter -->|rna_var| vep
    filter_pass -->|wgs,wes,panel,rna_var| bcftools_stats
